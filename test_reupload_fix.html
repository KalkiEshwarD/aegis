<!DOCTYPE html>
<html>
<head>
    <title>Test Re-upload After Delete Fix</title>
    <script src="https://unpkg.com/@apollo/client@3.14.0/client.min.js"></script>
</head>
<body>
    <h1>Test: Re-upload File After Delete</h1>
    <p>This test verifies that the fix for re-uploading deleted files works correctly.</p>

    <button onclick="runFullTest()">Run Full Test (Upload → Delete → Re-upload)</button>
    <button onclick="clearResults()">Clear Results</button>

    <div id="results"></div>

    <script>
        const { ApolloClient, InMemoryCache, createHttpLink, gql } = window.Apollo;

        const client = new ApolloClient({
            link: createHttpLink({
                uri: 'http://localhost:8080/graphql',
                headers: {
                    'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c'
                }
            }),
            cache: new InMemoryCache()
        });

        const UPLOAD_MUTATION = gql`
            mutation UploadFileFromMap($input: UploadFileFromMapInput!) {
                uploadFileFromMap(input: $input) {
                    id
                    filename
                    mime_type
                    created_at
                    file {
                        id
                        size_bytes
                        content_hash
                    }
                }
            }
        `;

        const DELETE_MUTATION = gql`
            mutation DeleteFile($id: ID!) {
                deleteFile(id: $id)
            }
        `;

        const GET_FILES_QUERY = gql`
            query GetUserFiles {
                userFiles {
                    id
                    filename
                    file {
                        content_hash
                    }
                }
            }
        `;

        let uploadedFileId = null;
        const testContentHash = "test_reupload_hash_" + Date.now();
        const testFileData = "SGVsbG8gV29ybGQgLSBUZXN0IGNvbnRlbnQgZm9yIHJldXBsb2Fk"; // "Hello World - Test content for reupload"

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            results.innerHTML += `<p style="color: ${color}">[${timestamp}] ${message}</p>`;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function uploadFile(filename) {
            const testData = {
                filename: filename,
                content_hash: testContentHash,
                size_bytes: 35, // Length of decoded content
                mime_type: "text/plain",
                encrypted_key: "dGVzdF9lbmNyeXB0ZWRfa2V5",
                file_data: testFileData
            };

            log(`Uploading file: ${filename} with hash: ${testContentHash}`);

            try {
                const result = await client.mutate({
                    mutation: UPLOAD_MUTATION,
                    variables: {
                        input: {
                            data: JSON.stringify(testData)
                        }
                    }
                });

                const userFile = result.data.uploadFileFromMap;
                uploadedFileId = userFile.id;
                log(`✅ Upload successful! File ID: ${userFile.id}, File record ID: ${userFile.file.id}`, 'success');
                return userFile;
            } catch (error) {
                log(`❌ Upload failed: ${error.message}`, 'error');
                throw error;
            }
        }

        async function deleteFile() {
            if (!uploadedFileId) {
                log('❌ No file to delete', 'error');
                return;
            }

            log(`Deleting file with ID: ${uploadedFileId}`);

            try {
                await client.mutate({
                    mutation: DELETE_MUTATION,
                    variables: { id: uploadedFileId }
                });
                log('✅ Delete successful!', 'success');
            } catch (error) {
                log(`❌ Delete failed: ${error.message}`, 'error');
                throw error;
            }
        }

        async function reuploadFile() {
            log('Attempting to re-upload the same file...');

            try {
                const userFile = await uploadFile("reuploaded_file.txt");
                log('✅ Re-upload successful! This confirms the fix works.', 'success');
                return userFile;
            } catch (error) {
                log(`❌ Re-upload failed: ${error.message}`, 'error');
                log('This indicates the fix may not be working properly.', 'error');
                throw error;
            }
        }

        async function runFullTest() {
            clearResults();
            log('🚀 Starting full test: Upload → Delete → Re-upload');

            try {
                // Step 1: Upload file
                log('Step 1: Uploading file...');
                await uploadFile("original_file.txt");

                // Step 2: Delete file
                log('Step 2: Deleting file...');
                await deleteFile();

                // Step 3: Re-upload same file
                log('Step 3: Re-uploading same file...');
                await reuploadFile();

                log('🎉 Full test completed successfully! The re-upload after delete fix is working.', 'success');

            } catch (error) {
                log(`💥 Test failed: ${error.message}`, 'error');
            }
        }

        // Auto-run test when page loads (optional)
        // window.onload = () => setTimeout(runFullTest, 1000);
    </script>
</body>
</html>